# ECK-Stack-HA

## Objectives:
Deploy a highly available authenticated elasticsearch cluster with budget 300$ for 6 months.

## Challenges Identified
1. **High availablity**
    - Mutiple nodes(at least 3) in multiple zones on region are needed for high availabilty and fault tolerance

2. **Cost**
    - 50$ per month on Google CLoud Platform to run whole stack(VM, storage, data transfer, ip address), with GKE first cluster is an advantage so control plane cost is negated

3. **Performance**
    - Each cluster node need to have good spec to be up and running

4. **Authentication**
    - Trafic is secured between node and on outside world access to cluster
    
## Solution Overview


To keep the cost of 3 nodes with good spec under $50 per month, **spot VMs** are essential in this case. Kubernetes can automatically reschedule Elasticsearch (ES) nodes if a spot VM is preempted (terminated).

Using Kubernetesâ€™ Elastic Cloud on Kubernetes (ECK) operator simplifies setting up and managing an Elasticsearch cluster. Based on GKE's **regional setup**, 3 nodes is placed in 3 zones, and using **Kubernetes topology spread constraints**, ECK ensures ES nodes are evenly distributed across all zones. This setup improves high availability and fault tolerance, making the cluster resilient to zone failures. Traffic also secure by default when using ECK, data transport between node and node to other service are encrypt with certificate generated by ECK. 

With two node pools config, **spot node pool** and **on-demand backup node pool**, if all spot VMs are preempted at nearly same time, the on-demand backup nodes will automatically scale up to handle the traffic, ensure continuity and minimize downtime. An additional drain job is running as cronjob on k8s cluster, it'll schedule the pods are running on-demand node back to spot node. On-demand nodes's running time are reduced a considerable amount in this case.




- **Detail spec and pricing**:
    - Spot worker nodes(3 t2d-standard-2, 2 cores CPU 8GB RAM ) : 27$
    - Boost disk (3 * 30GB) : 9$
    - Persistent disk SSD( 3* 10GB, can be more): 3$
    - Network Load Balancer: 7$
    - Data Egress (10 GB): 1.2$

- **Setup**
    * GKE with terraform

        cd .tf\
        terraform init\
        terraform plan\
        terraform apply
    * Deploy ECK in K8s cluster

        https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-deploy-eck.html

    * Deploy Elasticsearch cluster, Kibana, APM server

        cd ECK && kubectl apply -f .